<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="theme-color" content="#000" />
    <title>
        
            Rust高阶生命周期绑定 &middot;  Laika
        
    </title>

    
	<link href="https://cdn.bootcdn.net/ajax/libs/pure/2.0.3/pure-min.css" rel="stylesheet" crossorigin="anonymous">
    
    
	<link href="https://cdn.bootcdn.net/ajax/libs/pure/2.0.3/grids-responsive-min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans+Condensed:wght@300&family=Merriweather:ital,wght@0,300;0,700;1,300&display=swap" rel="stylesheet">
    <link rel="icon" href="/img/favicon.ico" type="image/x-icon">

    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/atom.xml" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="">
    
    
    <meta name="description" content="有时无法静态描述一个生命周期，Rust中提供了一种&#34;动态&#34;绑定生命周期的方式。">
    

    
    <meta name="keywords" content="rust,lifetime,hrtbs">
    
    <meta name="author" content="Xiaopeng Li"><link href="https://atelierbram.github.io/syntax-highlighting/archive/assets/css/prism/prism-base16-mocha.dark.css" rel="stylesheet" />
</head>
<body>
        <div class="container"><div id="navbar" class="pure-menu pure-menu-open pure-menu-horizontal pure-menu-scrollable">
    <a href="/" class="pure-menu-heading">
        
            Laika 
         
    </a>
    <ul class="pure-menu-list">
        <li class="pure-menu-item">
            <a href="/posts" class="pure-menu-link">
                <i class="fa fa-archive"></i>
                Articles
            </a>
        </li>
        <li class="pure-menu-item">
            <a href="/tags" class="pure-menu-link">
                <i class="fas fa-comments"></i>
                Categories
            </a>
        </li>
        <li class="pure-menu-item">
            <a href="/about" class="pure-menu-link">
                <i class="fas fa-smile"></i>
                About
            </a>
        </li>
    </ul>
    <ul class="pure-menu-list pull-right">
        
        <li class="pure-menu-item">
            <a href="https://github.com/xiaopengli89" title="Github" class="pure-menu-link">
                <i class="fab fa-github"></i>
                <span class="hide">Github</span>
            </a>
        </li>
        
        
        
        <li class="pure-menu-item">
            <a href="https://www.linkedin.com/in/%E5%B0%8F%E9%B9%8F-%E6%9D%8E-078a86124/" title="Linked In" class="pure-menu-link">
                <i class="fab fa-linkedin"></i>
                <span class="hide">LinkedIn</span>
            </a>
        </li>
        
        
        
        <li class="pure-menu-item">
            <a href="/posts/index.xml" title="Atom Feed" class="pure-menu-link">
                <i class="fas fa-rss-square"></i>
                <span class="hide">RSS Feed</span>
            </a>
        </li>
    </ul>
</div>
<div class="pure-u-1">
    <div class="pad">
    </div>
</div>
<div class="pure-g">


<div id="content" class="pure-u-1 pure-u-md-3-4 pure-u-sm-1">
    <div class="pad">
<div class="date">
    <time pubdate="2020-07-03">July 3, 2020</time>
    <span class="author">by Xiaopeng Li</span>
</div>

<article>
    <h1><a href="/posts/rust-hrtbs/">Rust高阶生命周期绑定</a></h1>
    <div class="tags">
        
        
        <a href="/tags/rust" class="pure-button">rust</a>
        
        
        <a href="/tags/lifetime" class="pure-button">lifetime</a>
        
        
        <a href="/tags/hrtbs" class="pure-button">hrtbs</a>
        
    </div>
    <p>Rust中，<code>lifetime</code> 其实也是一种类型参数，可以看成范型的一种特殊形式。编译时需要将所有类型（包括 <code>lifetime</code> ）确定下来，比如：</p>
<pre><code class="language-rust">fn foo&lt;'a&gt;(x: &amp;'a i32) {
	// ...
}

'a: {
	let x = 1;
	foo::&lt;'a&gt;(&amp;x);
}
</code></pre>
<p>上面的 <code>'a</code> 生命周期其实就是变量 <code>x</code> 所在的block。</p>
<p>这个例子很简单，但如果我们换个闭包类型看看：</p>
<pre><code class="language-rust">fn foo&lt;'a&gt;(f: Box&lt;dyn Fn(&amp;'a i32)&gt;) {
    let x = 1;
    f(&amp;x);
	{
		let y = 2;
		f(&amp;y);
	}
}
</code></pre>
<p>第一次调用 <code>f(&amp;x)</code> 时生命周期 <code>'a</code> 等于变量 <code>x</code> 的生命周期；而在第二次调用 <code>f(&amp;y)</code> 时，生命周期 <code>'a</code> 又等于了变量 <code>y</code> 的生命周期；而变量 <code>x</code> 和变量 <code>y</code> 的生命周期显然是不同的。因此无法用一个静态的生命周期来描述 <code>'a</code> ，我们希望的是，闭包 <code>f</code> 在具体调用时绑定具体的生命周期，比如调用 <code>f(&amp;x)</code> 时绑定的是 <code>x</code> 的生命周期，而调用 <code>f(&amp;y)</code> 时绑定的是 <code>y</code> 的生命周期。</p>
<p>Rust中可以用 <code>高阶生命周期绑定（HRTBs）</code> 来实现&quot;动态&quot;生命周期绑定，其语法如下：</p>
<pre><code class="language-rust">for&lt;'a&gt; Trait
</code></pre>
<p>比如上面的例子就可以写成：</p>
<pre><code class="language-rust">fn foo(f: Box&lt;dyn for&lt;'a&gt; Fn(&amp;'a i32)&gt;) {
    let x = 1;
    f(&amp;x);
	{
		let y = 2;
		f(&amp;y);
	}
}
</code></pre>
<p>这样生命周期 <code>'a</code> 就不再是静态的了，他会随着闭包 <code>f</code> 的调用绑定到不同的生命周期：<code>f(&amp;x)</code> 调用时绑定到 <code>x</code> 的生命周期，<code>f(&amp;y)</code> 调用时绑定到 <code>y</code> 的生命周期。</p>
<p>不过大多数时候我们很少见到 <code>HRTBs</code> ，因为闭包的生命周期省略的话，编译器会帮我们自动生成 <code>高阶生命周期绑定</code> 。</p>
<p>而 <code>HRTBs</code> 的全称是 <code>Higher-Rank Trait Bounds</code>，翻译成 <code>高阶特质绑定</code> 可能更为合适，并且它只能在绑定 <code>trait</code> 时声明，不过目前只支持对生命周期参数的绑定，所以我翻译它叫 <code>高阶生命周期绑定</code> 。</p>
</article>

    </div>
</div>


                
<div id="sidebar" class="pure-u-1 pure-u-md-1-4 pure-u-sm-1">
    <div class="pad">
        <a name="about"></a>
        <h3>About Me</h3>
        <div style="text-align: center;">
            <img src="/img/DvZdstGUUAANxzC.jpg" alt="Xiaopeng Li" class="pure-img" />
            <p><em>Sorcerer in C.E.</em></p>
        </div>

        <h3>Latest Articles</h3>
        <div class="pure-menu pure-menu-open">
            <ul class="pure-menu-list">
                
                <li class="pure-menu-item">
                    <a href="/posts/plain-rt/" class="pure-menu-link">实现一个无依赖的Rust异步运行时<br>
                        <small>一个基本的Rust异步运行时实现，不依赖第三方crate，单文件，非常直观地解释Rust异步的基本原理。</small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="/posts/rust-hrtbs/" class="pure-menu-link">Rust高阶生命周期绑定<br>
                        <small>有时无法静态描述一个生命周期，Rust中提供了一种&#34;动态&#34;绑定生命周期的方式。</small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="/posts/rust-box-heap/" class="pure-menu-link">Rust动态内存分配<br>
                        <small>学习Rust的内存管理及实现一个简单的Box。</small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="/posts/rust-no-std/" class="pure-menu-link">不使用Rust标准库编写一个可运行的程序<br>
                        <small>Rust是一门真正的系统编程语言。</small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="/posts/rust-procedural-macro-1/" class="pure-menu-link">Rust过程宏（一）<br>
                        <small>开始Rust元编程，利用Rust的derive派生宏，消除重复的样板代码。</small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="/posts/rust-closure/" class="pure-menu-link">Rust闭包<br>
                        <small>Rust也可以函数式，像动态创建&#34;函数&#34;一样使用闭包。</small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="/posts/go-mysql-driver-race/" class="pure-menu-link">关于Go Mysql Driver引入QueryContext带来的数据竞争<br>
                        <small>并发编程里的常见问题--数据竞争。</small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="/posts/go-mysql-driver-eof/" class="pure-menu-link">关于Go Mysql Driver的unexpected EOF错误<br>
                        <small>应该是大多数Golang开发者日志里的东西了。</small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="/posts/socket-optimize/" class="pure-menu-link">关于Socket应用的性能优化<br>
                        <small>一点网络优化的小技巧。</small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="/posts/two-queue/" class="pure-menu-link">2Q(双链)缓存淘汰策略<br>
                        <small>经典LRU算法的实用变体。</small>
                    </a>
                </li>
                
            </ul>
        </div>

        <h3>Categories</h3>
        <div style="text-align:center" class="tags">
            
            
            <a href="/tags/rust" class="pure-button"> rust
                <small>(8)</small></a>
            
            
            
            <a href="/tags/database" class="pure-button"> database
                <small>(2)</small></a>
            
            
            
            <a href="/tags/golang" class="pure-button"> golang
                <small>(2)</small></a>
            
            
            
            <a href="/tags/kernel" class="pure-button"> kernel
                <small>(2)</small></a>
            
            
            
            <a href="/tags/linux" class="pure-button"> linux
                <small>(2)</small></a>
            
            
            
            <a href="/tags/memory" class="pure-button"> memory
                <small>(2)</small></a>
            
            
            
            <a href="/tags/mysql" class="pure-button"> mysql
                <small>(2)</small></a>
            
            
            
            <a href="/tags/tcp" class="pure-button"> tcp
                <small>(2)</small></a>
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
        </div>
    </div> 
</div> 

                
            </div><div class="pure-g">
	<footer class="pure-u-1 pure-u-md-1 pure-u-sm-1">
		<p>This page and its contents are copyright &copy; 2020,
			<a href="">Xiaopeng Li</a>.</p>
		<p><a href="https://github.com/pravin/hugo-theme-prav">Theme Prav</a> by <a href="https://cto.me.uk">Pravin
				Paratey</a></p>
	</footer>

	<script defer src="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.1/js/all.min.js" crossorigin="anonymous"></script>
</div>
</div><script src="https://cdn.bootcdn.net/ajax/libs/prism/1.20.0/prism.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/prism/1.20.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script>Prism.plugins.autoloader.languages_path = 'https://cdn.bootcdn.net/ajax/libs/prism/1.20.0/components/'</script>
</body>
</html>
